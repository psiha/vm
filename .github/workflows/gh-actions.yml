name: Build & Test

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    name: ${{ matrix.config.name }} â€” ${{ matrix.build_type }}
    runs-on: ${{ matrix.config.os }}
    timeout-minutes: 25

    strategy:
      fail-fast: false
      matrix:
        config:
          - { os: windows-latest, name: MSVC,        cc: msvc,   cxx: msvc,    gen: '' }
          - { os: windows-latest, name: Clang-CL,    cc: msvc,   cxx: msvc,    gen: '-T ClangCL' }
          - { os: ubuntu-latest,  name: Clang,       cc: clang,  cxx: clang++, gen: '-G Ninja' }
          - { os: ubuntu-latest,  name: GCC,         cc: gcc-15, cxx: g++-15,  gen: '-G Ninja' }
          - { os: macos-26,       name: Apple-Clang, cc: clang,  cxx: clang++, gen: '-G Ninja' }
        build_type: [Debug, Release]

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup latest Xcode
      if: matrix.config.name == 'Apple-Clang'
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest

    - name: macOS homebrew git bug workaround
      if: matrix.config.name == 'Apple-Clang'
      run: |
        export PATH="/usr/bin:$PATH"
        which git
        git --version

    - name: Install LLVM/Clang 21
      if: matrix.config.name == 'Clang'
      # https://apt.llvm.org
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod u+x llvm.sh
        sudo ./llvm.sh 21 all
        echo "PATH=/usr/lib/llvm-21/bin:$PATH" >> $GITHUB_ENV
        echo "LLVM_PATH=/usr/lib/llvm-21" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=/usr/lib/llvm-21/lib" >> $GITHUB_ENV
        echo "DYLD_LIBRARY_PATH=/usr/lib/llvm-21/lib" >> $GITHUB_ENV
        echo "CC=/usr/lib/llvm-21/bin/clang" >> $GITHUB_ENV
        echo "CXX=/usr/lib/llvm-21/bin/clang++" >> $GITHUB_ENV

    - name: Install GCC 15
      if: matrix.config.name == 'GCC'
      run: |
        sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
        sudo apt-get update
        sudo apt-get install -y gcc-15 g++-15
        echo "CC=gcc-15" >> $GITHUB_ENV
        echo "CXX=g++-15" >> $GITHUB_ENV

    - name: Set reusable strings
      id: strings
      shell: bash
      run: |
        echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"

    - name: Configure CMake
      run: >
        cmake -B ${{ steps.strings.outputs.build-output-dir }}
        ${{ matrix.config.gen }}
        -DCMAKE_CXX_COMPILER=${{ matrix.config.cxx }}
        -DCMAKE_C_COMPILER=${{ matrix.config.cc }}
        -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        -DGitHubCIRun=true
        -S ${{ github.workspace }}

    - name: Build
      run: |
        cmake --build ${{ steps.strings.outputs.build-output-dir }} --config ${{ matrix.build_type }} -j
        cmake --build ${{ steps.strings.outputs.build-output-dir }} --config ${{ matrix.build_type }} --target vm_unit_tests -j

    - name: Test
      working-directory: ${{ steps.strings.outputs.build-output-dir }}
      env:
        # https://github.com/actions/runner-images/issues/8891
        ASAN_WIN_CONTINUE_ON_INTERCEPTION_FAILURE: 1
      run: >
        cd ${{ steps.strings.outputs.build-output-dir }}/test &&
        ctest --progress --extra-verbose --output-on-failure --build-config ${{ matrix.build_type }}
